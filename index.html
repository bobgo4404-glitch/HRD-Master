<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRD Master x HR PRO Integration</title>
    
    <!-- 1. Core Libraries -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Styles -->
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard', sans-serif; background-color: #F8FAFC; color: #1E293B; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(226, 232, 240, 0.8); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); z-index: 9999; }
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
            .glass-panel { box-shadow: none; border: 1px solid #ddd; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, deleteDoc, updateDoc, getDocs, query, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const { useState, useEffect } = React;
        const Recharts = window.Recharts || {};
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, AreaChart, Area, PieChart, Pie, Cell } = Recharts;

        // 전역 날짜 변수
        const TODAY = new Date();
        const CUR_YEAR = TODAY.getFullYear();
        const CUR_MONTH = TODAY.getMonth() + 1;

        // ==========================================
        // [설정 구역] Firebase Configuration
        // ==========================================

        const TARGET_APP_ID = "hr-pro-secure-v4"; 

        const SEARCH_CANDIDATES = [
            "hr_employees_v36", "hr_employees_v37", "hr_employees_v38", 
            "employees", "users", "members", "staff", "personnel",
            "data", "public_data", "user_list", "hr_data"
        ];

        // 1. HR PRO (사원 데이터 소스)
        const hrProConfig = {
            apiKey: "AIzaSyB1ArSM5lNFhhSeQ1NCiPEKOSaQxc4anSk",
            authDomain: "hr-pro-ce4d0.firebaseapp.com",
            projectId: "hr-pro-ce4d0",
            storageBucket: "hr-pro-ce4d0.firebasestorage.app",
            messagingSenderId: "723857885735",
            appId: "1:723857885735:web:a7e5878e232f011f6a1c02",
            measurementId: "G-VNNPXC31G1"
        };

        // 2. HRD Master (교육 데이터 저장소)
        const hrdMasterConfig = {
             apiKey: "AIzaSyAyD5om8NyiaKmwEy3TrnoHZ7ftLNLLdow",
             authDomain: "hrd-master.firebaseapp.com",
             projectId: "hrd-master",
             storageBucket: "hrd-master.firebasestorage.app",
             messagingSenderId: "135107134432",
             appId: "1:135107134432:web:8c292d08cb564a27c2a185",
             measurementId: "G-WZ1B513CYQ"
        };

        const isMasterConfigValid = !!hrdMasterConfig.apiKey;
        const activeMasterConfig = isMasterConfigValid ? hrdMasterConfig : hrProConfig;

        // --- Firebase Init ---
        const appMaster = initializeApp(activeMasterConfig, "HRD_MASTER");
        const dbMaster = getFirestore(appMaster);
        const authMaster = getAuth(appMaster);

        const appHR = initializeApp(hrProConfig, "HR_PRO_LINK");
        const dbHR = getFirestore(appHR);
        const authHR = getAuth(appHR);

        // --- Data Converter ---
        const convertToEmployee = (doc) => {
            const data = doc.data() || {};
            return {
                id: doc.id,
                name: data.name || data.userName || data.fullName || data.koreanName || '이름미정',
                dept: data.dept || data.department || data.teamName || data.team || '미배정',
                position: data.position || data.rankName || data.rank || data.jobTitle || '사원',
                status: data.status || '재직',
                complianceRate: data.complianceRate || 0,
                joinDate: data.joinDate || ''
            };
        };

        // --- UI Components & Icons ---
        const Icons = {
            LayoutDashboard: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="9" rx="1"/><rect x="14" y="3" width="7" height="5" rx="1"/><rect x="14" y="12" width="7" height="9" rx="1"/><rect x="3" y="16" width="7" height="5" rx="1"/></svg>,
            BookOpen: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
            Calendar: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
            Users: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            ShieldAlert: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg>,
            GraduationCap: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>,
            BarChart3: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>,
            FileText: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>,
            Download: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Search: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
            ChevronRight: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>,
            Plus: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Trash2: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            Edit: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
            Upload: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            Printer: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>,
            X: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            TrendingUp: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
            Target: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
            Filter: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>,
            List: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>,
            Grid: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>,
            CheckCircle: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>,
            Activity: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        };

        const StatusBadge = ({ status }) => {
            const styles = { '이수': 'bg-emerald-100 text-emerald-700', '미이수': 'bg-rose-100 text-rose-700', '진행중': 'bg-blue-100 text-blue-700', '예정': 'bg-slate-100 text-slate-600', '마감': 'bg-gray-200 text-gray-600', '법정': 'bg-violet-100 text-violet-700', '직무': 'bg-indigo-100 text-indigo-700', 'High': 'bg-rose-50 text-rose-600', 'Medium': 'bg-amber-50 text-amber-600', 'Low': 'bg-slate-50 text-slate-600', '재직': 'bg-emerald-50 text-emerald-600', '휴직': 'bg-amber-50 text-amber-600', '퇴사': 'bg-gray-50 text-gray-400' };
            let display = status;
            if(status === 'High') display = '위험'; if(status === 'Medium') display = '주의'; if(status === 'Low') display = '양호';
            return <span className={`px-2.5 py-1 rounded-full text-xs font-semibold ${styles[status] || 'bg-slate-50'}`}>{display}</span>;
        };

        // --- COMPONENTS ---

        const SystemStatusModal = ({ onClose, status, dataCounts, authErrors, activeCollection, scanLog }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center modal-overlay" onClick={onClose}>
                <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg border border-gray-100" onClick={e => e.stopPropagation()}>
                    <h3 className="text-lg font-bold mb-4 flex items-center text-gray-800"><Icons.Activity className="w-5 h-5 mr-2 text-indigo-600"/> AI 자동 연결 진단</h3>
                    <div className="space-y-4 text-sm">
                        <div className="bg-gray-50 p-4 rounded-lg">
                            <h4 className="font-bold text-gray-700 mb-2">1. HR PRO (사원 DB)</h4>
                            <div className="flex justify-between mb-1">
                                <span>인증 상태:</span> 
                                <span className={status.hrAuth ? "text-green-600 font-bold" : "text-red-500 font-bold"}>{status.hrAuth ? "연결됨" : "실패"}</span>
                            </div>
                            <div className="mt-3 p-3 bg-gray-100 rounded border border-gray-200 font-mono text-[10px] max-h-32 overflow-y-auto">
                                <div className="font-bold text-gray-600 mb-1">[탐색 로그]</div>
                                {scanLog.map((log, i) => (<div key={i} className={log.includes("성공") ? "text-green-600 font-bold" : "text-gray-400"}>{log}</div>))}
                                {scanLog.length === 0 && <div className="text-gray-400">탐색 대기중...</div>}
                            </div>
                            <div className="flex justify-between mt-3"><span>가져온 사원 수:</span> <span className="font-bold text-indigo-600 text-lg">{dataCounts.employees} 명</span></div>
                        </div>
                        <div className="bg-gray-50 p-4 rounded-lg">
                            <h4 className="font-bold text-gray-700 mb-2">2. HRD Master (교육 DB)</h4>
                            <div className="flex justify-between"><span>설정 상태:</span> <span className={status.masterConfig ? "text-green-600" : "text-rose-500 font-bold"}>{status.masterConfig ? "정상" : "API Key 누락"}</span></div>
                        </div>
                    </div>
                    <button onClick={onClose} className="w-full bg-indigo-600 text-white py-2.5 rounded-xl font-bold mt-6 hover:bg-indigo-700 transition">닫기</button>
                </div>
            </div>
        );

        const Analytics = ({ analytics, employees, records, courses, selectedYear, onUpdateAnalytics }) => {
            const [data, setData] = useState(analytics.length > 0 ? analytics : [
                {name: '리더십', sat: 0, app: 0}, {name: '직무기술', sat: 0, app: 0}, {name: '법정공통', sat: 0, app: 0}, {name: 'OA스킬', sat: 0, app: 0}
            ]);
            const [isEdit, setIsEdit] = useState(false);

            useEffect(() => { if(analytics.length > 0) setData(analytics); }, [analytics]);

            const handleSave = () => { onUpdateAnalytics(data); setIsEdit(false); };
            const handleChange = (idx, field, val) => {
                const newData = [...data]; newData[idx][field] = parseFloat(val); setData(newData);
            };

            const filteredRecords = records.filter(r => r.date && r.date.startsWith(selectedYear));
            
            return (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 animate-fade-in">
                    <div className="glass-panel p-6 rounded-2xl relative">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="font-bold text-gray-800 text-lg">교육 만족도 분석</h3>
                            <button onClick={() => isEdit ? handleSave() : setIsEdit(true)} className="text-xs bg-gray-100 px-3 py-1 rounded hover:bg-gray-200 font-bold">{isEdit ? '저장 완료' : '데이터 입력'}</button>
                        </div>
                        {isEdit ? (
                            <div className="space-y-2 h-72 overflow-y-auto">
                                {data.map((d, i) => (
                                    <div key={i} className="flex items-center space-x-2 text-xs">
                                        <span className="w-16 font-bold">{d.name}</span>
                                        <input type="number" step="0.1" value={d.sat} onChange={e => handleChange(i,'sat',e.target.value)} className="w-16 border rounded p-1" placeholder="만족도"/>
                                        <input type="number" step="0.1" value={d.app} onChange={e => handleChange(i,'app',e.target.value)} className="w-16 border rounded p-1" placeholder="적용도"/>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="h-72">
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={data} barSize={20}><CartesianGrid strokeDasharray="3 3" vertical={false} /><XAxis dataKey="name"/><YAxis domain={[0, 5]}/><Tooltip/><Legend/><Bar dataKey="sat" name="만족도" fill="#818CF8" radius={[4, 4, 0, 0]} isAnimationActive={false} /><Bar dataKey="app" name="현업적용도" fill="#34D399" radius={[4, 4, 0, 0]} isAnimationActive={false} /></BarChart>
                                </ResponsiveContainer>
                            </div>
                        )}
                    </div>
                    <div className="glass-panel p-6 rounded-2xl flex flex-col justify-center items-center text-center">
                        <div className="bg-emerald-100 p-4 rounded-full mb-4"><Icons.CheckCircle className="w-8 h-8 text-emerald-600"/></div>
                        <h3 className="font-bold text-gray-800 mb-2">교육 이수 완료율</h3>
                        <div className="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-emerald-600 to-teal-600 mb-2">
                             {employees.length > 0 ? Math.round((filteredRecords.length / employees.length) * 100) : 0}%
                        </div>
                        <p className="text-xs text-gray-400 mt-4">* {selectedYear}년도 전체 사원 대비 이수 비율</p>
                    </div>
                </div>
            );
        };

        const Reports = ({ employees, courses, records, selectedYear }) => {
            const [isPreview, setIsPreview] = useState(false);
            const handlePrint = () => window.print();
            const filteredRecords = records.filter(r => r.date && r.date.startsWith(selectedYear));

            return (
                <div className="glass-panel rounded-2xl p-12 animate-fade-in text-center max-w-4xl mx-auto mt-8 no-print">
                    <div className="inline-flex justify-center items-center w-24 h-24 bg-gradient-to-br from-indigo-50 to-violet-50 rounded-full mb-6 shadow-sm"><Icons.FileText className="w-10 h-10 text-indigo-500" /></div>
                    <h2 className="text-2xl font-bold text-gray-900 mb-3">보고서 자동 생성</h2>
                    <p className="text-gray-500 mb-10 text-lg">실시간 데이터를 기반으로 {selectedYear}년도 결과 보고서를 생성합니다.</p>
                    <button onClick={() => setIsPreview(true)} className="px-8 py-4 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 shadow-lg flex items-center justify-center mx-auto font-bold text-lg"><Icons.Download className="w-5 h-5 mr-3"/> 보고서 미리보기 & 출력</button>

                    {isPreview && (
                        <div className="fixed inset-0 z-50 bg-white overflow-y-auto print-only">
                            <div className="max-w-4xl mx-auto p-10">
                                <div className="flex justify-between items-center mb-8 no-print">
                                    <h1 className="text-2xl font-bold">미리보기</h1>
                                    <div className="space-x-2"><button onClick={handlePrint} className="bg-indigo-600 text-white px-4 py-2 rounded">인쇄</button><button onClick={() => setIsPreview(false)} className="bg-gray-200 px-4 py-2 rounded">닫기</button></div>
                                </div>
                                <div className="border p-8">
                                    <h1 className="text-3xl font-bold text-center mb-4">{selectedYear}년도 교육 결과 보고서</h1>
                                    <p className="text-center text-gray-500 mb-8">작성일: {new Date().toLocaleDateString()}</p>
                                    <h3 className="text-lg font-bold mb-2 border-b pb-2">1. 이수 현황 ({filteredRecords.length}건)</h3>
                                    <table className="w-full text-sm border-collapse border">
                                        <thead><tr className="bg-gray-100"><th className="border p-2">사번</th><th className="border p-2">성명</th><th className="border p-2">부서</th><th className="border p-2">이수율</th></tr></thead>
                                        <tbody>{employees.slice(0, 20).map(e => <tr key={e.id}><td className="border p-2 text-center">{e.id}</td><td className="border p-2 text-center">{e.name}</td><td className="border p-2 text-center">{e.dept}</td><td className="border p-2 text-center">{e.complianceRate}%</td></tr>)}</tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const Dashboard = ({ courses, records, employees, schedules, selectedYear }) => {
            const filteredRecords = records.filter(r => r.date && r.date.startsWith(selectedYear));
            const filteredSchedules = schedules.filter(s => s.date && s.date.startsWith(selectedYear));
            const completedRecords = filteredRecords.filter(r => r.status === '이수').length;
            const complianceRate = employees.length > 0 ? Math.round((completedRecords / employees.length) * 100) : 0;
            const hoursPerCapita = employees.length > 0 ? (filteredRecords.length * 2 / employees.length).toFixed(1) : 0;

            const deptStats = employees.reduce((acc, emp) => {
                if (!acc[emp.dept]) acc[emp.dept] = { name: emp.dept, count: 0 };
                const empRecords = filteredRecords.filter(r => r.empId === emp.id && r.status === '이수').length;
                acc[emp.dept].count += empRecords;
                return acc;
            }, {});
            const deptChartData = Object.values(deptStats).length > 0 ? Object.values(deptStats).sort((a,b)=>b.count-a.count) : [{name: '데이터 없음', count: 0}];

            const monthlyCounts = filteredSchedules.reduce((acc, curr) => {
                const month = curr.date.split('-')[1]; const key = parseInt(month, 10) + '월';
                if (!acc[key]) acc[key] = 0; acc[key]++; return acc;
            }, {});
            const monthlyData = Object.keys(monthlyCounts).length > 0 ? Object.keys(monthlyCounts).sort((a,b)=>parseInt(a)-parseInt(b)).map(k => ({ name: k, act: monthlyCounts[k] })) : [{name: '데이터 없음', act: 0}];

            const categoryData = [{ name: '법정', value: courses.filter(c => c.type === '법정').length }, { name: '직무', value: courses.filter(c => c.type === '직무').length }, { name: '역량', value: courses.filter(c => c.type === '역량').length }].filter(d=>d.value>0);
            const pieChartData = categoryData.length > 0 ? categoryData : [{name: '없음', value: 1}];
            const COLORS = ['#6366F1', '#10B981', '#F59E0B'];

            return (
                <div className="space-y-6 animate-fade-in pb-12">
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div className="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                            <div className="flex justify-between items-start mb-2"><div className="p-2 bg-indigo-50 rounded-lg text-indigo-600"><Icons.Users className="w-6 h-6"/></div><span className="text-xs font-bold px-2 py-1 rounded-full bg-gray-100 text-gray-500">Total</span></div>
                            <div className="mt-2"><p className="text-sm text-gray-500 font-medium">총 임직원</p><h3 className="text-3xl font-bold text-gray-900 mt-1">{employees.length}<span className="text-lg font-normal text-gray-400 ml-1">명</span></h3></div>
                        </div>
                        <div className="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                            <div className="flex justify-between items-start mb-2"><div className="p-2 bg-rose-50 rounded-lg text-rose-600"><Icons.Target className="w-6 h-6"/></div><span className="text-xs font-bold px-2 py-1 rounded-full bg-gray-100 text-gray-500">이수율</span></div>
                            <div className="mt-2"><p className="text-sm text-gray-500 font-medium">법정 교육 이수율</p><h3 className="text-3xl font-bold text-gray-900 mt-1">{complianceRate}<span className="text-lg font-normal text-gray-400 ml-1">%</span></h3></div>
                            <div className="w-full bg-gray-100 h-1.5 mt-4 rounded-full overflow-hidden"><div className="h-full bg-rose-500" style={{width: `${complianceRate}%`}}></div></div>
                        </div>
                        <div className="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                            <div className="flex justify-between items-start mb-2"><div className="p-2 bg-emerald-50 rounded-lg text-emerald-600"><Icons.BookOpen className="w-6 h-6"/></div><span className="text-xs font-bold px-2 py-1 rounded-full bg-emerald-50 text-emerald-600">Avg</span></div>
                            <div className="mt-2"><p className="text-sm text-gray-500 font-medium">1인당 평균 학습</p><h3 className="text-3xl font-bold text-gray-900 mt-1">{hoursPerCapita}<span className="text-lg font-normal text-gray-400 ml-1">Hrs</span></h3></div>
                        </div>
                        <div className="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                            <div className="flex justify-between items-start mb-2"><div className="p-2 bg-amber-50 rounded-lg text-amber-600"><Icons.TrendingUp className="w-6 h-6"/></div><span className="text-xs font-bold px-2 py-1 rounded-full bg-amber-50 text-amber-600">ROI</span></div>
                            <div className="mt-2"><p className="text-sm text-gray-500 font-medium">교육 투자 ROI</p><h3 className="text-3xl font-bold text-gray-900 mt-1">{filteredRecords.length > 0 ? '154' : '0'}<span className="text-lg font-normal text-gray-400 ml-1">%</span></h3></div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[400px]">
                        <div className="glass-panel p-6 rounded-2xl lg:col-span-2 flex flex-col">
                            <h4 className="font-bold text-gray-800 text-lg mb-6 flex items-center"><span className="w-2 h-6 bg-indigo-500 rounded-full mr-2"></span>월별 교육 실적 ({selectedYear})</h4>
                            <div className="flex-1 w-full min-h-0">
                                <ResponsiveContainer width="100%" height="100%">
                                    <AreaChart data={monthlyData}><defs><linearGradient id="colorAct" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#6366F1" stopOpacity={0.3}/><stop offset="95%" stopColor="#6366F1" stopOpacity={0}/></linearGradient></defs><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#E2E8F0"/><XAxis dataKey="name" axisLine={false} tickLine={false} tick={{fill: '#94A3B8', fontSize: 12}} dy={10} /><YAxis axisLine={false} tickLine={false} tick={{fill: '#94A3B8', fontSize: 12}} /><Tooltip contentStyle={{borderRadius: '12px', border: 'none', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)'}} /><Area type="monotone" dataKey="act" stroke="#6366F1" strokeWidth={3} fillOpacity={1} fill="url(#colorAct)" isAnimationActive={false} /></AreaChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                        <div className="glass-panel p-6 rounded-2xl flex flex-col">
                            <h4 className="font-bold text-gray-800 text-lg mb-4 flex items-center"><span className="w-2 h-6 bg-emerald-500 rounded-full mr-2"></span>부서별 이수 현황</h4>
                            <div className="flex-1 w-full min-h-0 relative">
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart layout="vertical" data={deptChartData}><CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#E2E8F0"/><XAxis type="number" hide /><YAxis dataKey="name" type="category" tick={{fontSize: 12, fill: '#475569'}} width={60} /><Tooltip cursor={{fill: '#F1F5F9'}} contentStyle={{borderRadius: '8px'}} /><Bar dataKey="count" fill="#10B981" radius={[0, 4, 4, 0]} barSize={20} isAnimationActive={false} /></BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 h-[300px]">
                        <div className="glass-panel p-6 rounded-2xl flex flex-col">
                            <h4 className="font-bold text-gray-800 text-lg mb-4">운영 포트폴리오</h4>
                            <div className="flex-1 relative">
                                <ResponsiveContainer width="100%" height="100%">
                                    <PieChart><Pie data={pieChartData} cx="50%" cy="50%" innerRadius={60} outerRadius={80} paddingAngle={5} dataKey="value" isAnimationActive={false}>{pieChartData.map((entry, index) => (<Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />))}</Pie><Tooltip /><Legend verticalAlign="bottom"/></PieChart>
                                </ResponsiveContainer>
                                <div className="absolute inset-0 flex items-center justify-center pointer-events-none"><div className="text-center"><span className="text-3xl font-bold text-gray-800">{courses.length}</span><span className="block text-xs text-gray-400">Courses</span></div></div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const CourseManagement = ({ courses, onAdd, onDelete }) => {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [formData, setFormData] = useState({ name: '', type: '법정', law: '', cycle: '연간', hours: 1, target: '전사' });

            const handleSave = () => {
                if (!formData.name) return alert("과정명을 입력하세요.");
                onAdd({ ...formData, riskLevel: 'Low' });
                setIsModalOpen(false);
                setFormData({ name: '', type: '법정', law: '', cycle: '연간', hours: 1, target: '전사' });
            };

            return (
                <div className="glass-panel rounded-2xl p-6 animate-fade-in relative">
                    <div className="flex justify-between items-center mb-6 border-b pb-4">
                        <h2 className="text-xl font-bold text-gray-800">교육 과정 관리</h2>
                        <button onClick={() => setIsModalOpen(true)} className="bg-indigo-600 text-white px-5 py-2.5 rounded-xl text-sm font-semibold hover:bg-indigo-700 shadow-lg">+ 과정 등록</button>
                    </div>
                    <table className="w-full text-sm text-left">
                        <thead className="bg-gray-50 border-b"><tr><th className="p-4">구분</th><th className="p-4">과정명</th><th className="p-4">법령/근거</th><th className="p-4">주기/시간</th><th className="p-4">대상</th><th className="p-4 text-right">관리</th></tr></thead>
                        <tbody>{courses.map(c => <tr key={c.id} className="border-b hover:bg-gray-50"><td className="p-4"><StatusBadge status={c.type}/></td><td className="p-4 font-bold text-gray-700">{c.name}</td><td className="p-4 text-gray-500 text-xs">{c.law}</td><td className="p-4 text-gray-600">{c.cycle} / {c.hours}H</td><td className="p-4 text-gray-500">{c.target}</td><td className="p-4 text-right"><button onClick={() => onDelete(c.id)} className="text-rose-500 hover:bg-rose-50 p-2 rounded"><Icons.Trash2 className="w-4 h-4"/></button></td></tr>)}</tbody>
                    </table>
                    
                    {isModalOpen && ReactDOM.createPortal(
                        <div className="fixed inset-0 z-50 flex items-center justify-center modal-overlay" onClick={() => setIsModalOpen(false)}>
                            <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-bold mb-6 border-b pb-4">새 과정 등록</h3>
                                <div className="space-y-4">
                                    <div><label className="block text-sm font-bold text-gray-700 mb-1">과정명</label><input type="text" className="w-full border p-2.5 rounded-lg" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})}/></div>
                                    <div><label className="block text-sm font-bold text-gray-700 mb-1">분류</label><select className="w-full border p-2.5 rounded-lg" value={formData.type} onChange={e => setFormData({...formData, type: e.target.value})}><option>법정</option><option>직무</option><option>역량</option></select></div>
                                    <div><label className="block text-sm font-bold text-gray-700 mb-1">관련 법령</label><input type="text" className="w-full border p-2.5 rounded-lg" value={formData.law} onChange={e => setFormData({...formData, law: e.target.value})}/></div>
                                    <div className="flex gap-4"><div className="flex-1"><label className="block text-sm font-bold text-gray-700 mb-1">주기</label><input type="text" className="w-full border p-2.5 rounded-lg" value={formData.cycle} onChange={e => setFormData({...formData, cycle: e.target.value})}/></div><div className="flex-1"><label className="block text-sm font-bold text-gray-700 mb-1">시간(H)</label><input type="number" className="w-full border p-2.5 rounded-lg" value={formData.hours} onChange={e => setFormData({...formData, hours: e.target.value})}/></div></div>
                                    <div><label className="block text-sm font-bold text-gray-700 mb-1">대상</label><input type="text" className="w-full border p-2.5 rounded-lg" value={formData.target} onChange={e => setFormData({...formData, target: e.target.value})}/></div>
                                </div>
                                <div className="mt-8 flex space-x-3"><button onClick={() => setIsModalOpen(false)} className="flex-1 py-3 border rounded-xl font-bold">취소</button><button onClick={handleSave} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold">저장</button></div>
                            </div>
                        </div>, document.body
                    )}
                </div>
            );
        };

        const ScheduleManagement = ({ schedules, courses, selectedYear, onAdd, onDelete }) => {
            const [view, setView] = useState('list');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [formData, setFormData] = useState({ courseId: '', date: '', location: '', instructor: '' });
            const [currentMonth, setCurrentMonth] = useState(new Date().getMonth() + 1);

            const filtered = schedules.filter(s => s.date.startsWith(selectedYear));

            const handleSave = () => {
                if (!formData.courseId || !formData.date) return alert("과정과 날짜를 선택하세요.");
                onAdd({ ...formData, status: '예정' });
                setIsModalOpen(false);
                setFormData({ courseId: '', date: '', location: '', instructor: '' });
            };

            const daysInMonth = new Date(selectedYear, currentMonth, 0).getDate();
            const firstDayOfWeek = new Date(selectedYear, currentMonth - 1, 1).getDay();
            
            const prevMonth = () => setCurrentMonth(prev => prev === 1 ? 12 : prev - 1);
            const nextMonth = () => setCurrentMonth(prev => prev === 12 ? 1 : prev + 1);
            
            return (
                <div className="glass-panel rounded-2xl p-6 animate-fade-in relative h-full flex flex-col">
                    <div className="flex justify-between items-center mb-6 border-b pb-4 flex-shrink-0">
                        <h2 className="text-xl font-bold text-gray-800 flex items-center">
                            {selectedYear}년 교육 일정
                            {view === 'month' && <span className="ml-2 text-base font-normal text-gray-500">({currentMonth}월)</span>}
                        </h2>
                        <div className="flex gap-2">
                            <button onClick={() => setIsModalOpen(true)} className="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-indigo-700 transition">+ 일정 등록</button>
                            <div className="flex bg-gray-100 p-1 rounded-lg">
                                <button onClick={() => setView('list')} className={`px-3 py-1 text-sm rounded-md transition ${view==='list'?'bg-white shadow text-indigo-600 font-bold':'text-gray-500'}`}>리스트</button>
                                <button onClick={() => setView('month')} className={`px-3 py-1 text-sm rounded-md transition ${view==='month'?'bg-white shadow text-indigo-600 font-bold':'text-gray-500'}`}>달력</button>
                            </div>
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto">
                        {view === 'list' ? (
                            <div className="grid gap-4">
                                {filtered.length === 0 ? <div className="text-center py-20 text-gray-400 bg-gray-50 rounded-xl">등록된 일정이 없습니다.</div> :
                                filtered.map(s => {
                                    const c = courses.find(course => course.id === s.courseId);
                                    return <div key={s.id} className="flex justify-between p-5 border rounded-xl bg-white hover:shadow-sm transition">
                                        <div className="flex gap-4"><div className="bg-slate-100 p-3 rounded-xl text-center min-w-[60px]"><div className="text-xs text-gray-500">{s.date.split('-')[1]}월</div><div className="text-xl font-bold">{s.date.split('-')[2]}</div></div><div><h4 className="font-bold text-lg">{c?.name}</h4><p className="text-sm text-gray-500">{s.location} | {s.instructor}</p></div></div>
                                        <button onClick={()=>onDelete(s.id)} className="text-rose-500 p-2 hover:bg-rose-50 rounded-full transition"><Icons.Trash2 className="w-5 h-5"/></button>
                                    </div>
                                })}
                            </div>
                        ) : (
                            <div className="animate-fade-in h-full flex flex-col">
                                <div className="flex justify-between items-center mb-4 px-2">
                                    <button onClick={prevMonth} className="p-2 hover:bg-gray-100 rounded-full transition"><Icons.ChevronRight className="w-5 h-5 transform rotate-180 text-gray-600"/></button>
                                    <span className="font-bold text-lg text-gray-800">{currentMonth}월</span>
                                    <button onClick={nextMonth} className="p-2 hover:bg-gray-100 rounded-full transition"><Icons.ChevronRight className="w-5 h-5 text-gray-600"/></button>
                                </div>
                                <div className="grid grid-cols-7 gap-2 mb-2 text-center">
                                    {['일','월','화','수','목','금','토'].map((d,i) => <div key={d} className={`text-xs font-bold py-2 ${i===0?'text-rose-500':i===6?'text-blue-500':'text-gray-500'}`}>{d}</div>)}
                                </div>
                                <div className="grid grid-cols-7 gap-2 flex-1 auto-rows-fr">
                                    {Array.from({length: firstDayOfWeek}).map((_, i) => <div key={`empty-${i}`} className="bg-gray-50/30 rounded-lg"></div>)}
                                    {Array.from({length: daysInMonth}).map((_, i) => {
                                        const day = i + 1;
                                        const dateStr = `${selectedYear}-${String(currentMonth).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                                        const dayEvents = filtered.filter(s => s.date === dateStr);
                                        const isToday = new Date().toDateString() === new Date(selectedYear, currentMonth-1, day).toDateString();
                                        
                                        return (
                                            <div key={day} className={`border ${isToday ? 'border-indigo-500 bg-indigo-50/30' : 'border-gray-100 bg-white'} rounded-lg p-2 min-h-[100px] relative hover:border-indigo-300 transition group`}>
                                                <div className={`text-xs font-bold mb-1 ${isToday?'text-indigo-600':''}`}>{day}</div>
                                                <div className="space-y-1 overflow-y-auto max-h-[80px]">
                                                    {dayEvents.map(ev => {
                                                        const c = courses.find(course => course.id === ev.courseId);
                                                        return (
                                                            <div key={ev.id} className="text-[10px] bg-indigo-100 text-indigo-700 px-1.5 py-1 rounded border border-indigo-200 truncate relative group/item" title={`${c?.name} (${ev.instructor})`}>
                                                                {c?.name}
                                                                <button onClick={(e)=>{e.stopPropagation(); onDelete(ev.id);}} className="absolute right-0 top-0 bottom-0 px-1 bg-indigo-200 text-rose-600 opacity-0 group-hover/item:opacity-100 font-bold">×</button>
                                                            </div>
                                                        )
                                                    })}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                    </div>

                    {isModalOpen && ReactDOM.createPortal(
                        <div className="fixed inset-0 z-50 flex items-center justify-center modal-overlay" onClick={() => setIsModalOpen(false)}>
                            <div className="bg-white rounded-2xl shadow-2xl p-8 w-96" onClick={e => e.stopPropagation()}>
                                <h3 className="font-bold text-lg mb-6">새 일정 등록</h3>
                                <div className="space-y-4">
                                    <div><label className="block text-sm font-bold mb-1">과정</label><select className="w-full border p-2 rounded" value={formData.courseId} onChange={e=>setFormData({...formData, courseId: e.target.value})}><option value="">선택하세요</option>{courses.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
                                    <div><label className="block text-sm font-bold mb-1">날짜</label><input type="date" className="w-full border p-2 rounded" value={formData.date} onChange={e=>setFormData({...formData, date: e.target.value})}/></div>
                                    <div><label className="block text-sm font-bold mb-1">장소</label><input type="text" className="w-full border p-2 rounded" value={formData.location} onChange={e=>setFormData({...formData, location: e.target.value})}/></div>
                                    <div><label className="block text-sm font-bold mb-1">강사</label><input type="text" className="w-full border p-2 rounded" value={formData.instructor} onChange={e=>setFormData({...formData, instructor: e.target.value})}/></div>
                                </div>
                                <div className="mt-6 flex gap-3"><button onClick={() => setIsModalOpen(false)} className="flex-1 py-2 border rounded font-bold">취소</button><button onClick={handleSave} className="flex-1 py-2 bg-indigo-600 text-white rounded font-bold">등록</button></div>
                            </div>
                        </div>, document.body
                    )}
                </div>
            );
        };

        const ComplianceManager = ({ courses }) => (
            <div className="glass-panel rounded-2xl p-6 animate-fade-in">
                <h2 className="text-xl font-bold mb-4 flex items-center"><Icons.ShieldAlert className="w-5 h-5 mr-2 text-rose-600"/>법정 의무교육 모니터링</h2>
                <table className="w-full text-sm">
                    <thead><tr><th className="text-left p-2">과정명</th><th className="text-left p-2">위험도</th></tr></thead>
                    <tbody>{courses.filter(c => c.type === '법정').map(c => <tr key={c.id} className="border-b"><td className="p-2">{c.name}</td><td className="p-2"><StatusBadge status={c.riskLevel || 'Low'}/></td></tr>)}</tbody>
                </table>
            </div>
        );

        const EmployeeManager = ({ employees, onSelect }) => {
            const [search, setSearch] = useState('');
            const filtered = employees.filter(e => e.name?.includes(search) || e.dept?.includes(search));
            return (
                <div className="glass-panel rounded-2xl p-6 animate-fade-in flex flex-col h-full">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-lg font-bold flex items-center"><span className="w-2 h-2 bg-green-500 rounded-full mr-2"></span>HR PRO 연동됨 (읽기 전용)</h2>
                        <input type="text" placeholder="검색..." className="border p-2 rounded" onChange={e => setSearch(e.target.value)}/>
                    </div>
                    <div className="overflow-auto flex-1">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-50 sticky top-0"><tr><th className="p-3">이름</th><th className="p-3">부서</th><th className="p-3">직급</th><th className="p-3 text-right">관리</th></tr></thead>
                            <tbody>{filtered.map(e => <tr key={e.id} className="border-b hover:bg-gray-50"><td className="p-3 font-bold">{e.name}</td><td className="p-3">{e.dept}</td><td className="p-3">{e.position}</td><td className="p-3 text-right"><button onClick={()=>onSelect(e.id)} className="text-indigo-600 border px-2 py-1 rounded hover:bg-indigo-50 transition">상세</button></td></tr>)}</tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const EmployeeHistory = ({ employees, records, courses, selectedId, onSelectEmployee, onBack, onAddRecord, onDeleteRecord }) => {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [form, setForm] = useState({ courseId: '', date: '', score: 0, status: '이수' });
            const [searchTerm, setSearchTerm] = useState('');

            if (!selectedId) {
                const filtered = employees.filter(e => e.name.includes(searchTerm) || e.dept.includes(searchTerm));
                return (
                    <div className="glass-panel rounded-2xl p-8 animate-fade-in h-full flex flex-col">
                        <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <Icons.Search className="w-6 h-6 mr-2 text-indigo-600"/>
                            개인 이력 조회 대상 선택
                        </h3>
                        <div className="relative mb-4">
                            <Icons.Search className="w-4 h-4 absolute left-3 top-3 text-gray-400"/>
                            <input 
                                type="text" 
                                placeholder="이름 또는 부서 검색..." 
                                className="w-full pl-10 pr-4 py-2 border rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none bg-gray-50"
                                value={searchTerm}
                                onChange={e => setSearchTerm(e.target.value)}
                            />
                        </div>
                        <div className="flex-1 overflow-y-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-gray-50 sticky top-0"><tr><th className="p-3">이름</th><th className="p-3">부서</th><th className="p-3 text-right">선택</th></tr></thead>
                                <tbody>
                                    {filtered.map(e => (
                                        <tr key={e.id} className="border-b hover:bg-gray-50 cursor-pointer transition" onClick={() => onSelectEmployee(e.id)}>
                                            <td className="p-3 font-bold text-gray-800">{e.name} <span className="text-xs text-gray-400 font-normal">({e.position})</span></td>
                                            <td className="p-3 text-gray-600">{e.dept}</td>
                                            <td className="p-3 text-right"><button className="text-indigo-600 bg-indigo-50 px-3 py-1 rounded-lg text-xs font-bold hover:bg-indigo-100">조회</button></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            }

            const emp = employees.find(e => e.id === selectedId);
            if (!emp) return <div className="p-10 text-center">사원 정보를 찾을 수 없습니다. <button onClick={onBack} className="text-indigo-600 underline">목록으로</button></div>;
            const empRecords = records.filter(r => r.empId === emp.id);

            const handleAdd = () => {
                if(!form.courseId) return alert("과정 선택 필수");
                onAddRecord({ ...form, empId: emp.id, evidence: true });
                setIsModalOpen(false);
            };

            return (
                 <div className="glass-panel rounded-2xl p-8 animate-fade-in max-w-5xl mx-auto">
                    <button onClick={onBack} className="mb-6 text-sm text-gray-500 flex items-center hover:text-indigo-600 font-bold transition"><Icons.ChevronRight className="w-4 h-4 transform rotate-180 mr-1"/> 다른 사원 조회하기</button>
                    <div className="flex justify-between items-center mb-8 pb-8 border-b border-gray-100">
                        <div className="flex items-center space-x-6">
                            <div className="w-20 h-20 rounded-2xl bg-slate-200 flex items-center justify-center text-3xl font-bold text-slate-600">{emp.name?.[0]}</div>
                            <div><h2 className="text-3xl font-bold text-gray-900">{emp.name}</h2><p className="text-gray-500">{emp.dept} | {emp.id}</p></div>
                        </div>
                        <button onClick={() => setIsModalOpen(true)} className="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-indigo-700 transition">+ 이력 추가</button>
                    </div>
                    <div className="space-y-4">
                        {empRecords.map(r => {
                            const course = courses.find(c => c.id === r.courseId) || { name: '삭제된 과정', type: '-' };
                            return (
                                <div key={r.id} className="flex justify-between items-center p-5 bg-white border border-gray-100 rounded-xl hover:shadow-sm transition">
                                    <div><div className="flex items-center space-x-3 mb-1"><StatusBadge status={course.type} /><span className="font-bold text-gray-800 text-lg">{course.name}</span></div><div className="text-sm text-gray-500">완료: {r.date} | 점수: {r.score}</div></div>
                                    <div className="flex items-center space-x-3"><StatusBadge status={r.status} /><button onClick={() => onDeleteRecord(r.id)} className="text-rose-500 p-2 hover:bg-rose-50 rounded-full transition"><Icons.Trash2 className="w-4 h-4"/></button></div>
                                </div>
                            )
                        })}
                        {empRecords.length === 0 && <div className="text-center py-10 text-gray-400 bg-gray-50 rounded-xl">등록된 이수 내역이 없습니다.</div>}
                    </div>
                    {isModalOpen && ReactDOM.createPortal(
                        <div className="fixed inset-0 z-50 flex items-center justify-center modal-overlay" onClick={() => setIsModalOpen(false)}>
                            <div className="bg-white rounded-2xl shadow-xl w-96" onClick={e => e.stopPropagation()}>
                                <h3 className="font-bold text-lg mb-4">이력 등록</h3>
                                <select className="w-full border p-2 rounded mb-2" onChange={e => setForm({...form, courseId: e.target.value})}>
                                    <option value="">과정 선택</option>{courses.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                </select>
                                <input type="date" className="w-full border p-2 rounded mb-2" onChange={e => setForm({...form, date: e.target.value})}/>
                                <button onClick={handleAdd} className="w-full bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-700 transition">등록</button>
                            </div>
                        </div>, document.body
                    )}
                 </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [selectedYear, setSelectedYear] = useState(String(CUR_YEAR));
            const [data, setData] = useState({ courses: [], schedules: [], employees: [], records: [], analytics: [] });
            const [selectedEmpId, setSelectedEmpId] = useState(null);
            
            // 진단 모드 상태
            const [showStatusModal, setShowStatusModal] = useState(false);
            const [status, setStatus] = useState({ hrAuth: false, masterAuth: false, masterConfig: isMasterConfigValid });
            const [authErrors, setAuthErrors] = useState({ hr: null, master: null });
            const [activeCollection, setActiveCollection] = useState(null); 
            const [scanLog, setScanLog] = useState([]); // 탐색 로그 저장용

            // 1. 인증 확인
            useEffect(() => {
                const unsubAuthHR = getAuth(appHR).onAuthStateChanged(u => setStatus(s => ({...s, hrAuth: !!u})));
                signInAnonymously(getAuth(appHR)).catch(e => setAuthErrors(prev => ({...prev, hr: e.code})));
                const unsubAuthMaster = getAuth(appMaster).onAuthStateChanged(u => setStatus(s => ({...s, masterAuth: !!u})));
                signInAnonymously(getAuth(appMaster)).catch(e => setAuthErrors(prev => ({...prev, master: e.code})));
                return () => { unsubAuthHR(); unsubAuthMaster(); };
            }, []);

            // 2. 데이터 연동 로직
            useEffect(() => {
                const addLog = (msg) => setScanLog(prev => [...prev, msg]);
                const detectAndSubscribe = async () => {
                    if (activeCollection) return;
                    addLog("🚀 AI 딥 스캔 시작...");
                    let found = false;
                    for (const colName of SEARCH_CANDIDATES) {
                        try {
                            const q = query(collection(dbHR, colName), limit(1));
                            const snapshot = await getDocs(q);
                            if (!snapshot.empty) {
                                setActiveCollection(colName);
                                found = true;
                                onSnapshot(collection(dbHR, colName), (snap) => {
                                    const safeEmployees = snap.docs.map(d => convertToEmployee(d));
                                    safeEmployees.sort((a, b) => a.name.localeCompare(b.name, 'ko'));
                                    setData(prev => ({ ...prev, employees: safeEmployees }));
                                });
                                break;
                            }
                        } catch (e) {}
                    }
                    if (!found && TARGET_APP_ID) {
                        for (const colName of SEARCH_CANDIDATES) {
                            try {
                                const deepPath = collection(dbHR, "artifacts", TARGET_APP_ID, "public", "data", colName);
                                const snapshot = await getDocs(query(deepPath, limit(1)));
                                if (!snapshot.empty) {
                                    setActiveCollection(deepPath.path);
                                    found = true;
                                    onSnapshot(deepPath, (snap) => {
                                        const safeEmployees = snap.docs.map(d => convertToEmployee(d));
                                        safeEmployees.sort((a, b) => a.name.localeCompare(b.name, 'ko'));
                                        setData(prev => ({ ...prev, employees: safeEmployees }));
                                    });
                                    break;
                                }
                            } catch (e) {}
                        }
                    }
                };
                setTimeout(detectAndSubscribe, 1500);

                const unsubCourses = onSnapshot(collection(dbMaster, "courses"), (snap) => setData(p => ({...p, courses: snap.docs.map(d => ({id: d.id, ...d.data()}))})));
                const unsubSchedules = onSnapshot(collection(dbMaster, "schedules"), (snap) => setData(p => ({...p, schedules: snap.docs.map(d => ({id: d.id, ...d.data()}))})));
                const unsubRecords = onSnapshot(collection(dbMaster, "records"), (snap) => setData(p => ({...p, records: snap.docs.map(d => ({id: d.id, ...d.data()}))})));
                const unsubAnalytics = onSnapshot(collection(dbMaster, "analytics"), (snap) => { if(!snap.empty) setData(p => ({...p, analytics: snap.docs[0].data().items || []})); });
                return () => { unsubCourses(); unsubSchedules(); unsubRecords(); unsubAnalytics(); };
            }, []);

            const handleAddDoc = async (col, item) => { await setDoc(doc(collection(dbMaster, col)), { ...item, createdAt: new Date().toISOString() }); };
            const handleDeleteDoc = async (col, id) => { await deleteDoc(doc(dbMaster, col, id)); };
            const handleUpdateAnalytics = async (items) => { await setDoc(doc(collection(dbMaster, "analytics"), "stats"), { items }); };

            const menuItems = [
                { id: 'dashboard', label: '경영 대시보드', icon: Icons.LayoutDashboard },
                { id: 'courses', label: '교육 과정 관리', icon: Icons.BookOpen },
                { id: 'schedule', label: '교육 일정 관리', icon: Icons.Calendar },
                { id: 'employees', label: '사원 관리', icon: Icons.Users },
                { id: 'compliance', label: '법정교육/감사', icon: Icons.ShieldAlert },
                { id: 'history', label: '개인 이력 조회', icon: Icons.GraduationCap },
                { id: 'analytics', label: '성과/효과 분석', icon: Icons.BarChart3 },
                { id: 'reports', label: '보고서 출력', icon: Icons.FileText },
            ];

            return (
                <div className="flex h-screen overflow-hidden bg-[#F8FAFC]">
                    <aside className="w-72 bg-[#1a1c23] text-white flex flex-col flex-shrink-0 shadow-2xl z-20 no-print">
                        <div className="p-8 border-b border-gray-800">
                            <h1 className="text-xl font-bold flex items-center tracking-tight text-white"><div className="w-8 h-8 rounded-lg bg-indigo-600 flex items-center justify-center mr-3 shadow-lg shadow-indigo-500/50"><Icons.Users className="w-5 h-5 text-white"/></div>HRD 마스터</h1>
                            <p className="text-xs text-gray-500 mt-2 ml-1">HR PRO 데이터 연동됨</p>
                        </div>
                        <nav className="flex-1 overflow-y-auto py-6 px-4">
                            <ul className="space-y-1.5">{menuItems.map(item => <li key={item.id}><button onClick={() => setActiveTab(item.id)} className={`w-full flex items-center px-4 py-3.5 rounded-xl text-sm font-medium transition-all duration-200 group ${activeTab === item.id ? 'bg-indigo-600 text-white shadow-lg translate-x-1' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}`}><item.icon className={`w-5 h-5 mr-3 ${activeTab === item.id ? 'text-white' : 'text-gray-500 group-hover:text-white'}`} />{item.label}</button></li>)}</ul>
                        </nav>
                        <div className="p-6">
                            <button onClick={() => setShowStatusModal(true)} className="w-full bg-gray-800 hover:bg-gray-700 text-gray-300 text-xs py-2 rounded flex items-center justify-center border border-gray-700"><Icons.Activity className="w-3 h-3 mr-1"/> 시스템 진단</button>
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col overflow-hidden relative">
                        <header className="h-20 bg-white/80 backdrop-blur-md border-b border-gray-200/50 flex items-center justify-between px-10 z-10 sticky top-0 no-print">
                            <h2 className="text-xl font-bold text-gray-800 flex items-center">{menuItems.find(i => i.id === activeTab)?.label}</h2>
                            <div className="flex items-center space-x-6">
                                <div className="flex items-center bg-gray-100 rounded-lg px-3 py-1">
                                    <Icons.Filter className="w-4 h-4 text-gray-500 mr-2"/>
                                    <select value={selectedYear} onChange={(e) => setSelectedYear(e.target.value)} className="bg-transparent text-sm font-bold text-gray-700 outline-none cursor-pointer">
                                        <option value="2026">2026년</option><option value="2027">2027년</option><option value="2028">2028년</option><option value="2029">2029년</option><option value="2030">2030년</option>
                                    </select>
                                </div>
                            </div>
                        </header>
                        
                        <div className="flex-1 overflow-y-auto p-10 scroll-smooth">
                            <div className="max-w-7xl mx-auto">
                                {activeTab === 'dashboard' && <Dashboard courses={data.courses} records={data.records} employees={data.employees} schedules={data.schedules} selectedYear={selectedYear} />}
                                {activeTab === 'courses' && <CourseManagement courses={data.courses} onAdd={(item) => handleAddDoc('courses', item)} onDelete={(id) => handleDeleteDoc('courses', id)} />}
                                {activeTab === 'schedule' && <ScheduleManagement schedules={data.schedules} courses={data.courses} selectedYear={selectedYear} onAdd={(item) => handleAddDoc('schedules', item)} onDelete={(id) => handleDeleteDoc('schedules', id)} />}
                                {activeTab === 'employees' && <EmployeeManager employees={data.employees} onSelect={(id) => {setSelectedEmpId(id); setActiveTab('history');}} />}
                                {activeTab === 'compliance' && <ComplianceManager courses={data.courses} />}
                                {activeTab === 'history' && <EmployeeHistory employees={data.employees} records={data.records} courses={data.courses} selectedId={selectedEmpId} onSelectEmployee={(id) => setSelectedEmpId(id)} onBack={() => setSelectedEmpId(null)} onAddRecord={(item) => handleAddDoc('records', item)} onDeleteRecord={(id) => handleDeleteDoc('records', id)} selectedYear={selectedYear} />}
                                {activeTab === 'analytics' && <Analytics analytics={data.analytics} employees={data.employees} records={data.records} courses={data.courses} selectedYear={selectedYear} onUpdateAnalytics={handleUpdateAnalytics} />}
                                {activeTab === 'reports' && <Reports employees={data.employees} courses={data.courses} records={data.records} selectedYear={selectedYear} />}
                            </div>
                        </div>
                    </main>

                    {showStatusModal && <SystemStatusModal onClose={() => setShowStatusModal(false)} status={status} dataCounts={{employees: data.employees.length}} authErrors={authErrors} activeCollection={activeCollection} scanLog={scanLog} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>